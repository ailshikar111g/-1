<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>مشاهدتي برو - منصة القنوات المتكاملة</title>
  <style>
    :root{
      --bg: #0b0f14;
      --card: #121826;
      --muted: #9aa4b2;
      --text: #e5edf5;
      --accent: #3b82f6;
      --accent-2: #22c55e;
      --danger: #ef4444;
      --ring: #334155;
      --chip: #1f2937;
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius: 18px;
      --gradient-start: #1a2b4d;
      --gradient-end: #0e1522;
      --sidebar-width: 220px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: "Cairo", system-ui, -apple-system, Segoe UI, Roboto, "Noto Kufi Arabic", sans-serif;
      background: radial-gradient(ellipse at 15% -10%, #1e2b45 0%, #0b0f14 70%), var(--bg);
      color:var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* رأس الصفحة */
    header{
      position:sticky; top:0; z-index:50;
      background: rgba(11,15,20,.92);
      backdrop-filter: saturate(180%) blur(16px);
      border-bottom: 1px solid rgba(28, 40, 58, 0.6);
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .container{
      max-width:1200px; 
      margin-inline:auto; 
      padding:16px;
    }

    .row{
      display:flex; 
      gap:16px; 
      align-items:center; 
      flex-wrap:wrap;
      justify-content: space-between;
    }

    .app-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
    }

    .app-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #3b82f6, #22c55e);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .app-name {
      display: flex;
      flex-direction: column;
    }

    h1{
      font-size:clamp(20px,2.6vw,28px); 
      margin:0; 
      letter-spacing:.2px;
      background: linear-gradient(to right, #3b82f6, #22c55e);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-weight: 800;
    }

    .app-tagline {
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .search{
      position:relative; 
      flex:1 1 320px; 
      min-width:260px;
      max-width: 400px;
    }

    .search input{
      width:100%; 
      padding:14px 18px 14px 48px; 
      border-radius:999px; 
      border:1px solid var(--ring);
      background: rgba(14, 21, 34, 0.8); 
      color:var(--text); 
      outline:none;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    .search input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      background: rgba(14, 21, 34, 0.95);
    }

    .search svg{ 
      position:absolute; 
      left:16px; 
      top:50%; 
      transform:translateY(-50%); 
      opacity:.7;
      transition: opacity 0.3s ease;
    }

    /* زر المتجر */
    .store-btn {
      background: linear-gradient(135deg, #3b82f6, #22c55e);
      border: none;
      color: white;
      padding: 10px 16px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .store-btn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    /* التخطيط الرئيسي */
    .main-layout {
      display: flex;
      flex: 1;
    }

    /* الشريط الجانبي */
    .sidebar {
      width: var(--sidebar-width);
      background: rgba(11, 15, 20, 0.8);
      border-left: 1px solid rgba(28, 40, 58, 0.4);
      padding: 20px 0;
      height: calc(100vh - 80px);
      position: sticky;
      top: 80px;
      overflow-y: auto;
    }

    /* ألسنة (تبويبات) الباقات في الشريط الجانبي */
    .tabs{ 
      display:flex; 
      flex-direction: column;
      gap: 6px;
      padding: 0 12px;
    }

    .tab{
      padding:12px 16px;
      border-radius:12px; 
      cursor:pointer; 
      user-select:none;
      border:1px solid var(--ring); 
      background: rgba(14, 21, 34, 0.6); 
      color:var(--muted); 
      transition:all 0.3s ease;
      font-weight: 600;
      font-size: 14px;
      text-align: right;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tab:hover {
      background: rgba(27, 42, 68, 0.4);
      transform: translateX(-5px);
    }

    .tab.active{ 
      background:linear-gradient(135deg, var(--accent), #1e40af); 
      color:white; 
      border-color:rgba(59, 130, 246, 0.4);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
    }

    /* المحتوى الرئيسي */
    .main-content {
      flex: 1;
      padding: 24px 16px 40px;
    }

    /* الشبكة */
    .grid{
      display:grid; 
      gap:16px;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    }

    /* البطاقة */
    .card{
      position:relative; 
      border:1px solid rgba(40, 50, 70, 0.5); 
      background: linear-gradient(145deg, rgba(18, 26, 40, 0.9), rgba(11, 16, 25, 0.9));
      border-radius:var(--radius); 
      overflow:hidden; 
      box-shadow:var(--shadow);
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      isolation:isolate;
      padding-bottom:8px;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(to right, var(--accent), var(--accent-2));
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 1;
    }

    .card:hover{ 
      transform:translateY(-6px) scale(1.02); 
      border-color:rgba(59, 130, 246, 0.3); 
      box-shadow: 0 16px 40px rgba(0,0,0,.5);
    }

    .card:hover::before {
      opacity: 1;
    }

    .thumb{
      aspect-ratio:1/1; 
      display:grid; 
      place-items:center; 
      background:
        radial-gradient(60% 60% at 70% 20%, rgba(255,255,255,.08), rgba(0,0,0,0)),
        linear-gradient(140deg, rgba(59,130,246,.2), rgba(34,197,94,.2));
      position: relative;
      overflow: hidden;
      padding: 12px;
    }

    .thumb::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1) 0%, transparent 60%);
    }

    .logo{
      width:58%; 
      max-width:90px;
      aspect-ratio: 16/9; 
      border-radius:10px;
      display:grid; 
      place-items:center;
      background: rgba(11, 18, 32, 0.8); 
      border:1px solid rgba(49, 70, 104, 0.4); 
      color:#cbd5e1; 
      font-weight:800; 
      letter-spacing:.5px;
      text-transform:uppercase; 
      font-size: clamp(12px, 2.2vw, 16px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 1;
      transition: all 0.3s ease;
    }

    .card:hover .logo {
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(0,0,0,0.3);
      border-color: rgba(59, 130, 246, 0.6);
    }

    .content{ 
      padding:12px 14px 14px;
      display:flex; 
      flex-direction:column; 
      gap:8px;
    }

    .title{ 
      display:flex; 
      align-items:center; 
      justify-content:space-between; 
      gap:6px;
    }

    .name{ 
      font-weight:700; 
      font-size:13px;
      letter-spacing:.1px;
      line-height: 1.3;
    }

    .chips{ 
      display:flex; 
      flex-wrap:wrap; 
      gap:5px;
    }

    .chip{
      font-size:10px;
      padding:4px 8px;
      border-radius:999px; 
      background:var(--chip); 
      border:1px solid rgba(49, 70, 104, 0.4); 
      color:#cbd5e1;
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    .chip.live{ 
      border-color: rgba(239,68,68,.5); 
      background: rgba(239,68,68,.15); 
      color:#fecaca; 
    }

    .chip.hd{ 
      border-color: rgba(59,130,246,.5); 
      background: rgba(59,130,246,.15); 
    }

    .chip.uhd{ 
      border-color: rgba(34,197,94,.55); 
      background: rgba(34,197,94,.15); 
    }

    /* شارة الزاوية */
    .badge{
      position:absolute; 
      top:10px;
      right:10px;
      z-index:2; 
      padding:5px 10px;
      border-radius:999px;
      font-size:10px;
      background:rgba(0,0,0,.5); 
      border:1px solid rgba(255,255,255,.1);
      backdrop-filter: blur(6px);
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    /* زر التشغيل */
    .play-btn {
      all: unset;
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 8px;
      background: rgba(30, 41, 59, 0.7);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: var(--text);
      font-size: 11px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .play-btn:hover {
      background: rgba(30, 64, 175, 0.7);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
    }

    .play-btn::before {
      content: '▶';
      font-size: 9px;
    }

    /* زر المفضلة */
    .favorite-btn {
      all: unset;
      cursor: pointer;
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 2;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: var(--muted);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .favorite-btn:hover {
      color: #fecaca;
      border-color: rgba(239, 68, 68, 0.4);
      transform: scale(1.1);
      background: rgba(0, 0, 0, 0.8);
    }

    .favorite-btn.active {
      color: #ef4444;
      border-color: rgba(239, 68, 68, 0.6);
      background: rgba(239, 68, 68, 0.15);
      animation: pulse 1s ease;
    }

    /* صفحة المشغل */
    #player-page {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      z-index: 1000;
      display: none;
      flex-direction: column;
    }

    .player-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: linear-gradient(135deg, #1a1f2f, #0d121c);
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }

    .player-title {
      font-weight: 700;
      font-size: 18px;
      color: white;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .player-title-channel-logo {
      width: 30px;
      height: 20px;
      background: rgba(255, 255, 255, 0.06);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
    }

    .back-btn {
      background: rgba(255,255,255,0.06);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 50px;
      cursor: pointer;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .back-btn:hover {
      background: rgba(255,255,255,0.12);
    }

    .player-body {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
    }

    .player-video {
      width: 100%;
      height: 100%;
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      background: black;
    }

    /* فوتر صغير */
    footer{ 
      color:var(--muted); 
      font-size:12.5px; 
      border-top:1px solid rgba(28, 40, 58, 0.4); 
      padding:20px 16px;
      text-align: center;
      margin-top: 20px;
    }

    /* مودال الاشتراك */
    .modal {
      display: none; 
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .modal-content {
      background: #121826;
      padding: 20px;
      border-radius: 16px;
      max-width: 400px;
      text-align: center;
      color: white;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
      position: relative;
    }
    .close-btn {
      position: absolute;
      top: 12px;
      right: 16px;
      font-size: 20px;
      cursor: pointer;
    }

    /* رسوم متحركة */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card {
      animation: fadeIn 0.5s ease backwards;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    /* دعم الشاشات الصغيرة */
    @media (max-width: 768px){
      .main-layout { flex-direction: column; }
      .sidebar { width: 100%; height: auto; position: static; border-left: none; border-bottom: 1px solid rgba(28, 40, 58, 0.4); padding: 10px 0; }
      .tabs { flex-direction: row; overflow-x: auto; padding-bottom: 8px; justify-content: flex-start; }
      .tab { padding: 8px 12px; font-size: 12px; white-space: nowrap; }
      .grid{ grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 14px; }
    }

    @media (max-width: 480px){
      .grid{ grid-template-columns: repeat(2, 1fr); gap: 12px; }
      .app-brand { flex-direction: column; gap: 8px; margin-bottom: 10px; }
      .tab { padding: 7px 10px; font-size: 11px; }
      .name { font-size: 11px; }
      .player-header { flex-direction: column; gap: 10px; text-align: center; }
      .favorite-btn { width: 24px; height: 24px; font-size: 12px; }
    }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <!-- رأس الصفحة -->
  <header>
    <div class="container">
      <div class="row">
        <div class="app-brand" id="admin-access">
          <div class="app-icon">📺</div>
          <div class="app-name">
            <h1>مشاهدتي برو </h1>
            <span class="app-tagline">منصة القنوات المتكاملة</span>
          </div>
        </div>
        <button class="store-btn" onclick="openStore()">🛒 المتجر / الاشتراك</button>
<div class="search">
          <input id="q" type="search" placeholder="ابحث باسم القناة أو الرقم…" autocomplete="off" />
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21L15.8 15.8M18 10.5C18 14.6421 14.6421 18 10.5 18C6.35786 18 3 14.6421 3 10.5C3 6.35786 6.35786 3 10.5 3C14.6421 3 18 6.35786 18 10.5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
      </div>
    </div>
  </header>

  <!-- التخطيط الرئيسي -->
  <div class="main-layout">
    <!-- الشريط الجانبي -->
    <aside class="sidebar">
      <div class="tabs" id="tabs">
        <!-- سيتم ملء الأقسام تلقائياً من Firebase -->
      </div>
    </aside>

    <!-- المحتوى الرئيسي -->
    <main class="main-content">
      <!-- سيتم ملء أقسام القنوات تلقائياً من Firebase -->

      <!-- رسالة عدم وجود قنوات مفضلة -->
      <div class="no-favorites" id="no-favorites" style="display:none;">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 21.35L10.55 20.03C5.4 15.36 2 12.28 2 8.5C2 5.42 4.42 3 7.5 3C9.24 3 10.91 3.81 12 5.09C13.09 3.81 14.76 3 16.5 3C19.58 3 22 5.42 22 8.5C22 12.28 18.6 15.36 13.45 20.04L12 21.35Z" fill="currentColor"/>
        </svg>
        <p>لا توجد قنوات في المفضلة</p>
        <button class="action-btn" onclick="showAllChannels()">عرض جميع القنوات</button>
      </div>
    </main>
  </div>

  <!-- صفحة المشغل -->
  <div id="player-page">
    <div class="player-header">
      <button class="back-btn" onclick="closePlayer()">← رجوع</button>
      <div class="player-title">
        <span class="player-title-channel-logo" id="player-channel-logo"></span>
        <span id="player-title">تشغيل القناة</span>
      </div>
    </div>
    <div class="player-body">
      <video id="player-video" class="player-video" controls autoplay playsinline></video>
    </div>
  </div>

  <!-- مودال الاشتراك -->
  <div id="store-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeStore()">×</span>
      <h2>الاشتراك</h2>
      <p>للاشتراك وتشغيل القنوات على تلفازك:</p>
      <p><strong>2 دولار سنوياً</strong> عبر آسيا أو أثير</p>
      <p>للتواصل: <b>@ALI_SH_Z7</b></p>
          <p>اشترك:<b>في قناة التليكرام </b></p>
<h2>@BR_ALS</h2>
</div>
  </div>

  <footer class="container">
    مشاهدتي - منصة القنوات المتكاملة © 2025
  </footer>

  <!-- مكتبة تشغيل TS -->
  <script src="https://cdn.jsdelivr.net/npm/mpegts.js@latest/dist/mpegts.js"></script>
  <!-- مكتبة Shaka Player لتشغيل DASH + ClearKey -->
  <script src="https://cdn.jsdelivr.net/npm/shaka-player@latest/dist/shaka-player.compiled.js"></script>
  <!-- مكتبة HLS.js لتشغيل M3U8 -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    /****************************************************************
     * تهيئة Firebase
     ****************************************************************/
    const firebaseConfig = {
      apiKey: "AIzaSyCpDlm3OIXFLgY0OD0NKfjDfjQUUXHN2BU",
      authDomain: "watch-pro-ae457.firebaseapp.com",
      databaseURL: "https://watch-pro-ae457-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "watch-pro-ae457",
      storageBucket: "watch-pro-ae457.firebasestorage.app",
      messagingSenderId: "348050580472",
      appId: "1:348050580472:web:14cde3eb8700f1e39eac0d",
      measurementId: "G-LD55F0C64Z"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    /****************************************************************
     * دوال إنشاء البطاقات وإدارة المفضلة
     ****************************************************************/

    // دوال إنشاء البطاقات
    function getLogoText(opts){
      if(opts.num) return opts.num;
      const parts = opts.title.split(' ');
      return parts.length > 1 ? (parts[0].charAt(0) + (parts[1] ? parts[1].charAt(0) : '')) : opts.title.substring(0,2);
    }

    function createCard(opts){
      const card = document.createElement('div');
      card.className = 'card';
      card.dataset.brand = opts.category || 'other';
      card.dataset.name = (opts.title || '').toLowerCase();
      if(opts.num) card.dataset.num = String(opts.num);
      card.style.animationDelay = `${opts.delay || 0}ms`;

      card.innerHTML = `
        <span class="badge" data-brand="${opts.category || 'other'}">${(opts.category || 'chan').toUpperCase()}</span>
        <button class="favorite-btn">🤍</button>
        <div class="thumb"><div class="logo">${getLogoText(opts)}</div></div>
        <div class="content">
          <div class="title">
            <div class="name">${opts.title}</div>
            <button class="play-btn" data-url="${opts.url || ''}" data-type="${opts.type || 'ts'}" data-name="${opts.title}" data-keys='${opts.keys ? JSON.stringify(opts.keys) : ''}'>تشغيل</button>
          </div>
          <div class="chips">
            ${opts.quality?.includes('HD') ? '<span class="chip hd">HD</span>' : ''}
            ${opts.quality?.includes('UHD') ? '<span class="chip uhd">UHD</span>' : ''}
            ${opts.live ? '<span class="chip live">بث مباشر</span>' : ''}
          </div>
        </div>
      `;

      // تشغيل القناة
      const playBtn = card.querySelector('.play-btn');
      playBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        const url = this.getAttribute('data-url');
        const type = this.getAttribute('data-type');
        const name = this.getAttribute('data-name');
        const keysAttr = this.getAttribute('data-keys');
        const keys = keysAttr ? JSON.parse(keysAttr) : null;
        
        if (url) {
          openPlayer(name, url, type, { keys: keys });
        } else {
          alert(`عذراً، قناة ${name} غير متاحة للبث حالياً.`);
        }
      });

      // مفضلة
      const favoriteBtn = card.querySelector('.favorite-btn');
      favoriteBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        toggleFavorite(card, opts);
      });

      loadFavoriteState(card, opts);

      return card;
    }

    // حفظ/تحميل حالة المفضلة في localStorage
    function loadFavoriteState(card, opts){
      try {
        const favs = JSON.parse(localStorage.getItem('my_favs_v1') || '[]');
        const name = opts.title || card.dataset.name;
        if(favs.includes(name)) {
          const btn = card.querySelector('.favorite-btn');
          if(btn) btn.classList.add('active');
        }
      } catch(e){}
    }

    function toggleFavorite(card, opts){
      const name = opts.title || card.dataset.name;
      const key = 'my_favs_v1';
      let favs = JSON.parse(localStorage.getItem(key) || '[]');
      const idx = favs.indexOf(name);
      if(idx === -1){
        favs.push(name);
        const btn = card.querySelector('.favorite-btn');
        if(btn) btn.classList.add('active');
      } else {
        favs.splice(idx,1);
        const btn = card.querySelector('.favorite-btn');
        if(btn) btn.classList.remove('active');
      }
      localStorage.setItem(key, JSON.stringify(favs));
      updateFavoritesUI();
    }

    function updateFavoritesUI(){
      const favs = JSON.parse(localStorage.getItem('my_favs_v1') || '[]');
      document.querySelectorAll('.favorites-tab').forEach(t => {
        // just visual keep
      });
    }

    function updateFavoritesSection(){
      const favs = JSON.parse(localStorage.getItem('my_favs_v1') || '[]');
      const container = document.getElementById('favorites');
      if (!container) return;
      
      container.innerHTML = '';
      if(favs.length === 0){
        document.getElementById('no-favorites').style.display = 'block';
        return;
      } else {
        document.getElementById('no-favorites').style.display = 'none';
      }

      // نبحث في القنوات المحملة لإيجاد التطابقات
      const allChannels = getAllChannels();
      favs.forEach(name => {
        const found = allChannels.find(c => (c.title || '').toLowerCase() === name.toLowerCase());
        if(found){
          const card = createCard(found);
          container.appendChild(card);
        }
      });
    }

    /****************************************************************
     * تحميل البيانات من Firebase
     ****************************************************************/
    let allChannels = [];
    let categories = [];
    let categoriesOrder = [];

    // تحميل ترتيب الأقسام أولاً
    function loadCategoriesOrder() {
      return database.ref('categoriesOrder').once('value')
        .then(snapshot => {
          if (snapshot.exists()) {
            categoriesOrder = snapshot.val();
          } else {
            categoriesOrder = [];
          }
          return categoriesOrder;
        });
    }

    // تحميل الأقسام مع مراعاة الترتيب
    function loadCategories() {
      return database.ref('categories').once('value')
        .then(snapshot => {
          const tabsContainer = document.getElementById('tabs');
          tabsContainer.innerHTML = '';
          
          categories = [];
          
          if (snapshot.exists()) {
            const allCategories = snapshot.val();
            
            // فرز الأقسام حسب الترتيب المحفوظ
            const orderedCategories = [];
            
            if (categoriesOrder && categoriesOrder.length > 0) {
              // إضافة الأقسام حسب الترتيب المحفوظ
              categoriesOrder.forEach(categoryId => {
                if (allCategories[categoryId]) {
                  orderedCategories.push({
                    id: categoryId,
                    ...allCategories[categoryId]
                  });
                  delete allCategories[categoryId];
                }
              });
            }
            
            // إضافة الأقسام المتبقية التي ليس لها ترتيب
            Object.keys(allCategories).forEach(categoryId => {
              orderedCategories.push({
                id: categoryId,
                ...allCategories[categoryId]
              });
            });
            
            // إنشاء تبويبات للأقسام
            orderedCategories.forEach(category => {
              categories.push(category);
              
              const tab = document.createElement('div');
              tab.className = 'tab';
              tab.setAttribute('data-target', category.id);
              tab.textContent = category.name;
              
              tab.addEventListener('click', () => {
                switchTab(category.id);
              });
              
              tabsContainer.appendChild(tab);
            });
          }
          
          // إضافة تبويب المفضلة
          const favoritesTab = document.createElement('div');
          favoritesTab.className = 'tab favorites-tab';
          favoritesTab.setAttribute('data-target', 'favorites');
          favoritesTab.textContent = 'المفضلة ❤️';
          
          favoritesTab.addEventListener('click', () => {
            switchTab('favorites');
          });
          
          tabsContainer.appendChild(favoritesTab);
          
          // تفعيل أول تبويب افتراضيًا
          if (categories.length > 0) {
            tabsContainer.querySelector('.tab').classList.add('active');
          }
        });
    }

    // تحميل القنوات
    function loadChannels() {
      database.ref('channels').on('value', (snapshot) => {
        allChannels = [];
        const mainContent = document.querySelector('.main-content');
        
        // مسح المحتوى الحالي
        mainContent.querySelectorAll('section.grid').forEach(section => {
          if (section.id !== 'favorites') {
            section.remove();
          }
        });
        
        if (snapshot.exists()) {
          const channelsArray = [];
          
          // تحويل القنوات إلى مصفوفة للفرز
          snapshot.forEach((childSnapshot) => {
            const channel = childSnapshot.val();
            channelsArray.push({
              id: childSnapshot.key,
              ...channel
            });
          });
          
          // فرز القنوات حسب رقم القناة (إن وجد)
          channelsArray.sort((a, b) => {
            // إذا كان لكلتا القناتين أرقام، قم بفرزهما حسب الرقم
            if (a.num && b.num) {
              return parseInt(a.num) - parseInt(b.num);
            }
            // إذا كان لدى إحداهما فقط رقماً، ضعها أولاً
            if (a.num && !b.num) return -1;
            if (!a.num && b.num) return 1;
            // إذا لم يكن لدى أي منهما رقماً، احتفظ بالترتيب الأصلي
            return 0;
          });
          
          // حفظ القنوات المرتبة
          allChannels = channelsArray;
          
          // إنشاء أقسام القنوات
          categories.forEach(category => {
            const section = document.createElement('section');
            section.className = 'grid';
            section.id = category.id;
            section.style.display = 'none';
            
            // إضافة القنوات التي تنتمي لهذا القسم
            channelsArray
              .filter(channel => channel.category === category.id)
              .forEach((channel, index) => {
                const card = createCard({
                  ...channel,
                  delay: index * 50
                });
                section.appendChild(card);
              });
            
            mainContent.appendChild(section);
          });
          
          // إضافة قسم المفضلة
          const favoritesSection = document.createElement('section');
          favoritesSection.className = 'grid';
          favoritesSection.id = 'favorites';
          favoritesSection.style.display = 'none';
          mainContent.appendChild(favoritesSection);
          
          // تفعيل أول قسم افتراضيًا
          if (categories.length > 0) {
            const firstCategory = categories[0];
            document.getElementById(firstCategory.id).style.display = 'grid';
            updateFavoritesSection();
          }
        }
      });
    }

    // الحصول على جميع القنوات
    function getAllChannels() {
      return allChannels;
    }

    /****************************************************************
     * إدارة التبويبات والبحث
     ****************************************************************/
    function switchTab(targetId) {
      // إخفاء جميع الأقسام
      document.querySelectorAll('.main-content > section.grid').forEach(section => {
        section.style.display = 'none';
      });
      
      // إلغاء تفعيل جميع التبويبات
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // تفعيل التبويب المحدد
      document.querySelector(`.tab[data-target="${targetId}"]`).classList.add('active');
      
      // عرض القسم المحدد
      if (targetId === 'favorites') {
        updateFavoritesSection();
        document.getElementById('favorites').style.display = 'grid';
      } else {
        document.getElementById(targetId).style.display = 'grid';
      }
    }

    // البحث
    document.getElementById('q').addEventListener('input', function() {
      const query = this.value.toLowerCase().trim();
      const allCards = document.querySelectorAll('.card');
      
      allCards.forEach(card => {
        const name = card.dataset.name || '';
        const num = card.dataset.num || '';
        const matches = name.includes(query) || num.includes(query);
        card.style.display = matches ? '' : 'none';
      });
    });

    // إظهار جميع القنوات
    function showAllChannels() {
      document.getElementById('q').value = '';
      document.querySelectorAll('.card').forEach(card => {
        card.style.display = '';
      });
    }

    /****************************************************************
     * إدارة المشغل
     ****************************************************************/
    let player = null;
    let hls = null;
    let shakaPlayer = null;

    function openPlayer(name, url, type, options = {}) {
      const playerPage = document.getElementById('player-page');
      const playerTitle = document.getElementById('player-title');
      const playerChannelLogo = document.getElementById('player-channel-logo');
      const video = document.getElementById('player-video');
      
      playerTitle.textContent = name;
      playerChannelLogo.textContent = name.substring(0, 2).toUpperCase();
      playerPage.style.display = 'flex';
      
      // إيقاف أي مشغل سابق
      if (player) {
        player.unload();
        player.destroy();
        player = null;
      }
      
      if (hls) {
        hls.destroy();
        hls = null;
      }
      
      if (shakaPlayer) {
        shakaPlayer.destroy();
        shakaPlayer = null;
      }
      
      video.src = '';
      
      // بدء التشغيل حسب نوع الملف
      if (type === 'ts') {
        if (mpegts.isSupported()) {
          player = mpegts.createPlayer({
            type: 'mse',
            url: url,
            isLive: true
          });
          player.attachMediaElement(video);
          player.load();
          player.play();
        } else {
          alert('متصفحك لا يدعم تشغيل هذا النوع من الفيديو');
        }
      } else if (type === 'm3u8') {
        if (Hls.isSupported()) {
          hls = new Hls();
          hls.loadSource(url);
          hls.attachMedia(video);
          hls.on(Hls.Events.MANIFEST_PARSED, function() {
            video.play();
          });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
          video.src = url;
          video.addEventListener('loadedmetadata', function() {
            video.play();
          });
        } else {
          alert('متصفحك لا يدعم تشغيل هذا النوع من الفيديو');
        }
      } else if (type === 'mpd') {
        shakaPlayer = new shaka.Player(video);
        shakaPlayer.addEventListener('error', (error) => {
          console.error('Shaka Player error:', error);
        });
        
        // إذا كان هناك مفاتيح تشفير
        if (options.keys) {
          const drmConfig = {
            clearKeys: {}
          };
          
          options.keys.forEach(keyObj => {
            drmConfig.clearKeys[keyObj.keyId] = keyObj.key;
          });
          
          shakaPlayer.configure({
            drm: drmConfig
          });
        }
        
        shakaPlayer.load(url).then(() => {
          console.log('Shaka Player loaded successfully');
        }).catch((error) => {
          console.error('Error loading with Shaka Player:', error);
        });
      } else if (type === 'mp4') {
        video.src = url;
        video.load();
        video.play();
      }
    }

    function closePlayer() {
      const playerPage = document.getElementById('player-page');
      playerPage.style.display = 'none';
      
      // إيقاف أي مشغل سابق
      if (player) {
        player.unload();
        player.destroy();
        player = null;
      }
      
      if (hls) {
        hls.destroy();
        hls = null;
      }
      
      if (shakaPlayer) {
        shakaPlayer.destroy();
        shakaPlayer = null;
      }
      
      const video = document.getElementById('player-video');
      video.src = '';
    }

    /****************************************************************
     * إدارة المتجر
     ****************************************************************/
    function openStore() {
      document.getElementById('store-modal').style.display = 'flex';
    }

    function closeStore() {
      document.getElementById('store-modal').style.display = 'none';
    }

    /****************************************************************
     * تهيئة التطبيق عند التحميل
     ****************************************************************/
    document.addEventListener('DOMContentLoaded', function() {
      // تحميل ترتيب الأقسام أولاً
      loadCategoriesOrder()
        .then(() => loadCategories())
        .then(() => loadChannels())
        .catch(error => {
          console.error('Error loading data:', error);
        });
      
      // إغلاق المتجر بالنقر خارج المحتوى
      document.getElementById('store-modal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeStore();
        }
      });
      
      // إغلاق المشغل بالزر ESC
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closePlayer();
        }
      });
    });
  </script>
</body>
</html>
